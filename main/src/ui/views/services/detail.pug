extends ../layout

block content
  .mt-4
    h4 Details
    a.btn.btn-outline-secondary(href=`/services/update/${service.id}`) Edit
    dl.row.mt-3
      dt.col-sm-3 Name
      dd.col-sm-9 #{service.name}

      dt.col-sm-3 Interfaces
      dd.col-sm-9 #{service.interfaces.join(', ')}

      dt.col-sm-3 Matching Domains
      dd.col-sm-9 #{service.matchingDomains.join(', ')}

      dt.col-sm-3 Route Optimization
      dd.col-sm-9
        if service.optimizeRoutes
          span.badge.bg-success Enabled
        else
          span.badge.bg-secondary Disabled

  .mt-4
    h4 Routes
    form(method="POST" action=`/services/remove-routes/${service.id}` onsubmit="return confirm('Are you sure you want to remove all routes for this service?')")
      button.btn.btn-outline-danger(type="submit") Remove All

    - const routesByDomain = service.routes.filter(route => route.comment?.startsWith('dns-auto:')).reduce((acc, route) => {
    -   const domain = route.comment.split(':')[2];
    -   if (!acc[domain]) acc[domain] = [];
    -   acc[domain].push(route);
    -   return acc;
    - }, {});
    - const routesByInterface = service.routes.filter(route => !route.comment?.startsWith('dns-auto:'));

    if service.routes.length === 0
      p.text-muted
        em No routes found for this service.
    else
      if Object.keys(routesByDomain).length > 0
        h5.mt-3 Auto-generated Routes (by Domain)
        .accordion#routesAccordion
          each routes, domain in routesByDomain
            - const filteredRoutes = routes.filter(route => !route.host?.includes('googlevideo.com'));
            if filteredRoutes.length > 0
              .accordion-item
                h2.accordion-header(id=`heading-${domain.replace(/\./g, '-')}`)
                  button.accordion-button(type='button' data-bs-toggle='collapse' data-bs-target=`#collapse-${domain.replace(/\./g, '-')}` aria-expanded='true' aria-controls=`collapse-${domain.replace(/\./g, '-')}`)
                    strong.me-2 #{domain}
                    span.badge.bg-primary #{filteredRoutes.length} routes
                .accordion-collapse.collapse.show(id=`collapse-${domain.replace(/\./g, '-')}` aria-labelledby=`heading-${domain.replace(/\./g, '-')}` data-bs-parent='#routesAccordion')
                  .accordion-body
                    .table-responsive
                      table.table.table-sm.table-striped
                        thead
                          tr
                            th Host IP
                            th Interface
                            th Gateway
                            th Comment
                        tbody
                          each route in filteredRoutes
                            tr
                              td #{route.host || route.network}
                              td #{route.interface}
                              td #{route.gateway || '-'}
                              td
                                small.text-muted #{route.comment}

      if routesByInterface.length > 0
        h5.mt-4 Manual Routes
        .table-responsive
          table.table.table-striped.table-hover
            thead
              tr
                th Network
                th Mask
                th Host
                th Interface
                th Gateway
                th Comment
            tbody
              each route in routesByInterface
                tr
                  td #{route.network || '-'}
                  td #{route.mask || '-'}
                  td #{route.host || '-'}
                  td #{route.interface}
                  td #{route.gateway || '-'}
                  td
                    small.text-muted #{route.comment || '-'}
