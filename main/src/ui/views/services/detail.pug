extends ../layout

block content
  article
    header
      nav(aria-label="breadcrumb")
        ul
          li
            a(href="/services") Services
          li #{service.name}
      h1 #{service.name}

    section
      h3 Service Details
      dl
        dt Name
        dd #{service.name}

        dt Interfaces
        dd #{service.interfaces.join(', ')}

        dt Matching Domains
        dd #{service.matchingDomains.join(', ')}

    section
      h3 Routes
      - const routesByDomain = service.routes.filter(route => route.comment?.startsWith('dns-auto:')).reduce((acc, route) => {
      -   const domain = route.comment.split(':')[2];
      -   if (!acc[domain]) acc[domain] = [];
      -   acc[domain].push(route);
      -   return acc;
      - }, {});
      - const routesByInterface = service.routes.filter(route => !route.comment?.startsWith('dns-auto:'));

      if service.routes.length === 0
        p
          em No routes found for this service.
      else
        if Object.keys(routesByDomain).length > 0
          h4 Auto-generated Routes (by Domain)
          each routes, domain in routesByDomain
            - const filteredRoutes = routes.filter(route => !route.host?.includes('googlevideo.com'));
            if filteredRoutes.length > 0
              details(open)
                summary
                  strong #{domain}
                  |  (#{filteredRoutes.length} routes)
                table
                  thead
                    tr
                      th Host IP
                      th Interface
                      th Gateway
                      th Comment
                  tbody
                    each route in filteredRoutes
                      tr
                        td #{route.host || route.network}
                        td #{route.interface}
                        td #{route.gateway || '-'}
                        td
                          small #{route.comment}

        if routesByInterface.length > 0
          h4 Manual Routes
          table
            thead
              tr
                th Network
                th Mask
                th Host
                th Interface
                th Gateway
                th Comment
            tbody
              each route in routesByInterface
                tr
                  td #{route.network || '-'}
                  td #{route.mask || '-'}
                  td #{route.host || '-'}
                  td #{route.interface}
                  td #{route.gateway || '-'}
                  td
                    small #{route.comment || '-'}

    footer
      div(role="group")
        a(href=`/services/update/${service.id}` role="button" class="secondary") Edit Service
        form(method="POST" action=`/services/remove-routes/${service.id}` style="display: inline;" onsubmit="return confirm('Are you sure you want to remove all routes for this service?')")
          button(type="submit" class="secondary") Remove All Routes
        form(method="POST" action=`/services/delete/${service.id}` style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this service?')")
          button(type="submit" class="contrast") Delete Service
        a(href="/services" role="button") Back to Services
