services:
  traefik:
    image: traefik:v3.0.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - default
      - shared

  glance:
    image: glanceapp/glance:v0.8.4
    restart: unless-stopped
    volumes:
      - ./glance/config:/app/config
      - ./glance/assets:/app/assets
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "8888:8080"
    networks:
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glance.rule=Host(`home.internal`)"
      - "traefik.http.routers.glance.entrypoints=web"
      - "traefik.http.services.glance.loadbalancer.server.port=8080"
      - "traefik.docker.network=shared"

  postgres-main:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
    volumes:
      - postgres_main_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dns2vpn"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-proxy:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
    volumes:
      - postgres_proxy_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dns2vpn"]
      interval: 5s
      timeout: 5s
      retries: 5

  dns-to-vpn:
    depends_on:
      postgres-main:
        condition: service_healthy
      dns-proxy:
        condition: service_started
    build:
      context: ./main
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./shared-logs:/logs
    environment:
      - WATCH_FILE=/logs/dns-proxy.log
      - POSTGRES_HOST=postgres-main
      - POSTGRES_PORT=5432
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
      - KEENETIC_HOST=${KEENETIC_HOST}
      - KEENETIC_LOGIN=${KEENETIC_LOGIN}
      - KEENETIC_PASSWORD=${KEENETIC_PASSWORD}
      - DNS_API_URL=http://dns-proxy:3001
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`admin.internal`)"
      - "traefik.http.routers.admin.entrypoints=web"
      - "traefik.http.services.admin.loadbalancer.server.port=3000"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  dns-proxy:
    depends_on:
      postgres-proxy:
        condition: service_healthy
    build:
      context: ./dns-proxy
    environment:
      - LOG_RESOLVED_TO_FILE=/logs/dns-proxy.log
      - HOST_TO_IP_FILE=/config/host-to-ip.txt
      - BLOCKLIST_FILE=/config/blocklist.txt
      - POSTGRES_HOST=postgres-proxy
      - POSTGRES_PORT=5432
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
      - ENABLE_API=true
      - API_PORT=3001
      # Upstream DNS servers: Use DNS over TLS for privacy
      # Format: protocol://host:port#servername
      # Examples:
      #   - dot://1.1.1.1:853#cloudflare-dns.com (Cloudflare DNS over TLS)
      #   - udp://192.168.1.1:53 (Plain DNS over UDP)
      # - UPSTREAM_DNS_SERVERS=dot://77.88.8.8:853#common.dot.dns.yandex.net
      - UPSTREAM_DNS_SERVERS=dot://1.1.1.1:853#cloudflare-dns.com
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3001:3001"
    volumes:
      - ./shared-logs:/logs
      - ./config:/config
    restart: unless-stopped

  vpn-toggle:
    depends_on:
      - dns-to-vpn
    build:
      context: ./vpn-toggle
      dockerfile: Dockerfile
    environment:
      - PORT=3002
      - MAIN_API_URL=http://dns-to-vpn:3000/api
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vpn-toggle.rule=Host(`vpn-toggle.internal`)"
      - "traefik.http.routers.vpn-toggle.entrypoints=web"
      - "traefik.http.services.vpn-toggle.loadbalancer.server.port=3002"
      - "traefik.docker.network=shared"
    restart: unless-stopped

networks:
  shared:
    name: shared

volumes:
  postgres_main_data:
  postgres_proxy_data:
